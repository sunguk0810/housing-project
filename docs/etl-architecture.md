# ETL 아키텍처

Housing Project는 공공 데이터 API에서 아파트 관련 정보를 수집(Extract), 가공(Transform), 적재(Load)합니다.
모든 데이터는 공공 API 또는 공식 데이터셋에서만 가져오며, 크롤링은 사용하지 않습니다.

## 수집 데이터 개요

```
┌─────────────────────────────────────────────────────────────┐
│                      공공 데이터 소스                         │
├──────────────┬──────────────┬───────────────┬───────────────┤
│  국토교통부   │  건축물대장   │  K-apt        │  기타          │
│  실거래 API   │  총괄표제부   │  상세정보     │               │
│              │  + 표제부     │              │               │
├──────────────┼──────────────┼───────────────┼───────────────┤
│ 매매/전세    │ 세대수       │ CCTV 수       │ 어린이집      │
│ 거래가격     │ 건물 공식명   │ 주차대수      │ (보건복지부)   │
│ 면적/층수    │              │ 엘리베이터    │               │
│ 건축년도     │              │ EV 충전기     │ 학교/학군      │
│              │              │ 지하철/버스   │ (교육부 NEIS)  │
│              │              │ 편의시설      │               │
│              │              │              │ 치안 통계      │
│              │              │              │ (행정안전부)   │
│              │              │              │               │
│              │              │              │ 통근 시간      │
│              │              │              │ (ODsay)       │
└──────────────┴──────────────┴───────────────┴───────────────┘
```

## ETL 실행 흐름

하나의 지역(예: 강남구)에 대한 ETL은 3단계로 실행됩니다.

```
for each region (강남구, 서초구, ...)
│
├─ Phase A: MOLIT 실거래 ──────────────────────────────────
│  │
│  │  월별 루프 (202602, 202601, ...)
│  │  ┌──────────┐     ┌──────────┐     ┌────────────────┐
│  │  │ 실거래   │────▶│ XML/JSON │────▶│  DB 저장       │
│  │  │ API 호출 │     │ 파싱     │     │  apartments    │
│  │  │ (매매)   │     │          │     │  apt_prices    │
│  │  ├──────────┤     │ + Kakao  │     └────────────────┘
│  │  │ 실거래   │────▶│ 지오코딩 │
│  │  │ API 호출 │     │ (주소→  │
│  │  │ (전세)   │     │  좌표)   │
│  │  └──────────┘     └──────────┘
│  │
│  ▼ 월별 루프 종료
│
├─ Phase B: 건축물대장 ────────────────────────────────────
│  │
│  │  리전당 1회 실행 (월별 반복 없음)
│  │
│  │  ① K-apt 목록에서 동→법정동코드 맵 구축
│  │  ② 아파트 주소에서 본번/부번 파싱
│  │     "역삼동 722-5" → bun=0722, ji=0005
│  │
│  │  ┌──────────────┐         ┌─────────────────┐
│  │  │ 총괄표제부   │──OK──▶ │ apartments      │
│  │  │ API          │         │  .household_    │
│  │  └──────┬───────┘         │   count         │
│  │         │ empty           │  .official_name │
│  │         ▼                 └────────▲────────┘
│  │  ┌──────────────┐                 │
│  │  │ 표제부 API   │──OK────────────┘
│  │  │ (fallback)   │
│  │  └──────┬───────┘
│  │         │ empty
│  │         ▼
│  │    ji=0000 재시도 → skip
│  │
│  ▼
│
├─ Phase C: K-apt 상세정보 ────────────────────────────────
│  │
│  │  리전당 1회 실행
│  │
│  │  Pass 1: 이름 매칭
│  │  ┌────────────────────────────────┐
│  │  │ 이름 정규화 (래미안 별칭 등)    │
│  │  │ → exact → includes → bigram   │
│  │  │ + 동 필터 + 차수 가드          │
│  │  │ + 건축물대장 공식명 활용        │
│  │  └────────────────────────────────┘
│  │
│  │  Pass 2: 좌표 매칭 (미매칭 건)
│  │  ┌────────────────────────────────┐
│  │  │ K-apt 도로명주소 → 지오코딩    │
│  │  │ → 거리 비교 (150m 이내)        │
│  │  │ + 이름 유사도 가드             │
│  │  └────────────────────────────────┘
│  │
│  │  매칭된 건만 API 호출
│  │  ┌──────────────┐     ┌─────────────────────┐
│  │  │ K-apt basic  │────▶│ apartment_details   │
│  │  │ + detail API │     │  CCTV, 주차, 지하철  │
│  │  └──────────────┘     │  EV충전, 편의시설    │
│  │                        └─────────────────────┘
│  ▼
│
└─ 다음 리전으로 ─────────────────────────────────────────
```

## 데이터 모델

```
apartments (아파트 기본)
├── apt_code          실거래 식별 코드
├── apt_name          아파트명 (MOLIT)
├── official_name     건축물대장 공식 건물명
├── address           주소
├── location          좌표 (PostGIS Point)
├── household_count   세대수 (건축물대장)
├── built_year        건축년도
├── area_min/max      면적 범위 (실거래 기준)
│
├── apartment_prices (1:N)
│   ├── trade_type    매매/전세
│   ├── year, month   거래 연월
│   ├── average_price 평균 거래가
│   ├── deal_count    거래 건수
│   └── area/floor    면적/층수 통계
│
└── apartment_details (1:1, K-apt)
    ├── kapt_code     K-apt 단지코드
    ├── cctv_count    CCTV 수
    ├── parking       주차 (지상/지하)
    ├── elevator      엘리베이터 수
    ├── ev_charger    전기차 충전기
    ├── subway/bus    대중교통 거리
    └── facilities    편의/복지/교육시설
```

## 실행 방법

```bash
# 전체 실행 (모든 지역, 최근 6개월)
pnpm exec tsx --env-file=.env src/etl/runner.ts --adapter=molit

# 특정 지역만 (강남구)
pnpm exec tsx --env-file=.env src/etl/runner.ts --adapter=molit --region=11680

# 최근 1개월만
pnpm exec tsx --env-file=.env src/etl/runner.ts --adapter=molit --region=11680 --months=1

# 검증
pnpm exec tsx --env-file=.env scripts/check-details.ts
```

## API 쿼터

| API | 일일 한도 | 비고 |
|---|---|---|
| data.go.kr (MOLIT/건축물대장/K-apt) | 2,000회 | 공유 한도 |
| Kakao 지오코딩 | 300,000회 | |
| ODsay 통근 | 1,000회 | |

강남구 1회 실행 시 약 500회 사용. 한도 초과 시 자동 중단되며, 재실행 시 이미 처리된 건은 스킵합니다 (멱등성).

## 데이터 출처

| 데이터 | 출처 | API |
|---|---|---|
| 아파트 실거래가 | 국토교통부 | RTMSDataSvcAptTrade/Rent |
| 세대수/건물정보 | 국토교통부 건축물대장 | BldRgstHubService |
| 단지 상세정보 | K-apt (공동주택관리정보) | AptBasisInfoServiceV4 |
| 어린이집 | 보건복지부 | 어린이집정보공개포털 |
| 학교/학군 | 교육부 | NEIS 학교정보 |
| 치안 통계 | 행정안전부 | MOIS 범죄통계 |
| 통근 시간 | ODsay | 대중교통 경로 |
